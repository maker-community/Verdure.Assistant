# 绿荫助手（Verdure Assistant）更新日志

本项目的所有重要更改都会记录在此文件中。

格式基于 [Keep a Changelog](https://keepachangelog.com/zh-CN/1.0.0/)，
版本号遵循 [语义化版本](https://semver.org/lang/zh-CN/)。

## [未发布]

### 🌟 重大技术突破

#### **MCP (Model Context Protocol) 协议集成** 
绿荫助手成为首个完整实现 xiaozhi-esp32 MCP 协议规范的 .NET 平台智能助手，实现了：
- 85% 协议合规性，支持完整的 JSON-RPC 2.0 通信流程
- IoT 设备自动发现和工具动态注册
- 实时设备状态同步和双向通信
- 语音聊天系统与 IoT 设备的无缝集成

### 新增
- 🚀 **MCP (Model Context Protocol) 协议支持** - 完整实现了 xiaozhi-esp32 MCP 协议规范
  - **MCP 服务器集成** - 支持 IoT 设备的 JSON-RPC 2.0 通信协议
  - **设备自动发现** - 自动检测和注册支持 MCP 的 IoT 设备
  - **工具动态注册** - 从 MCP 设备自动加载可用工具和功能
  - **设备状态同步** - 实时设备状态管理和更新
  - **协议合规性** - 85% MCP 协议规范符合度，完整的错误处理
- 🎙️ **语音活动检测 (VAD) 增强** - 实现连续监控和智能打断功能
  - **连续监控** - 在 AI 语音播放期间监控用户语音输入
  - **智能打断** - 检测到用户语音时立即中断 AI 回复
  - **状态感知处理** - 根据设备状态使用不同的能量阈值和语音窗口
  - **自动激活** - 空闲状态下检测到语音自动开始监听
- 🔄 **自动对话模式** - 实现基于 py-xiaozhi 的连续对话功能
  - **持续监听** - `KeepListening` 模式实现无缝对话体验
  - **状态管理** - 完整的设备状态机 (Idle, Connecting, Listening, Speaking)
  - **对话状态切换** - `ToggleChatStateAsync()` 手动控制对话流程
- 🔍 **关键词检测服务** - WinUI 平台连续关键词识别
  - **连续识别** - 解决 Microsoft Cognitive Services 的单次识别限制
  - **自动重启机制** - 关键词检测后自动重启识别器
  - **竞态条件防护** - 防止并发检测处理，确保状态一致性
- ⚙️ **完整设置系统** - 基于 Microsoft TemplateStudio 的泛型设置管理
  - **跨平台接口** - 泛型 `ISettingsService<T>` 接口设计
  - **Windows 平台实现** - 使用 ApplicationData 的本地存储
  - **导入导出功能** - 设置文件的导入导出和备份恢复
- 🏗️ **MVVM 架构重构** - WinUI 项目完整 MVVM 模式实现
  - **命令绑定** - 所有按钮事件转换为命令绑定模式
  - **属性绑定修复** - 修复所有 ViewModel 和 View 之间的绑定
  - **转换器实现** - 布尔值取反等自定义转换器
- 📸 **应用截图** - 添加 WinUI 应用界面截图展示
- 📖 **文档完善** - 更新 README 主页，添加应用截图区域

### 改进
- 🔧 **MCP 协议实现优化**
  - **响应处理修复** - 完善初始化、工具列表、工具调用响应处理
  - **错误恢复机制** - 增强 JSON-RPC 错误处理和自动恢复
  - **设备集成服务** - `McpIntegrationService` 桥接语音聊天和 IoT 设备
  - **WebSocket 集成** - MCP 消息封装和 WebSocket 协议整合
- 🎤 **语音中断功能增强**
  - **实时处理** - 16kHz 16-bit 单声道音频 20ms 帧分析
  - **智能阈值** - 说话状态 300.0 能量阈值，空闲状态 500.0 阈值
  - **快速响应** - 100ms 内检测并执行中断操作
- 🔊 **音频系统优化**
  - **资源冲突修复** - 解决 PortAudio 和系统音频服务的资源竞争
  - **编解码优化** - Opus 音频编解码器性能提升
  - **流管理改进** - 音频流的创建、管理和销毁优化
- 🔗 **连接稳定性提升**
  - **自动重连** - WebSocket 连接断线自动恢复机制
  - **连接状态管理** - 实时连接状态监控和用户界面更新
  - **错误处理** - 网络错误的智能处理和用户反馈
- 🧪 **测试覆盖扩展**
  - **MCP 协议测试** - 完整的协议合规性测试套件
  - **集成测试** - MCP WebSocket 集成测试和验证
  - **响应处理测试** - JSON-RPC 响应解析和处理验证

### 变更
- 🖼️ **资源管理** - 规范化应用截图和资源文件组织
- 📁 **目录结构** - 重新组织项目文件结构
  - 将主要项目移动到 `src/` 目录
  - 将测试项目移动到 `tests/` 目录  
  - 将示例代码移动到 `samples/` 目录
  - 将文档移动到 `docs/` 目录
  - 将构建脚本移动到 `scripts/` 目录
- 🔧 **解决方案文件** - 更新项目引用路径
- 📖 **README增强** - 添加应用截图展示，完善功能特性说明
- 🏛️ **架构升级** - 从单一"小智"服务扩展为多服务智能助手平台

### 修复
- 🐛 **SPXERR_INVALID_HANDLE 错误** - 修复语音识别服务的句柄管理问题
- 🔄 **线程同步问题** - 解决多线程环境下的竞态条件和死锁问题
- 🔌 **音频资源冲突** - 修复 PortAudio 资源占用和释放问题
- 🌐 **WebSocket 连接** - 修复连接管理和消息处理的稳定性问题
- 🎯 **关键词检测** - 修复连续识别中断和状态不一致问题
- 🔗 **依赖关系** - 优化 NuGet 包引用和项目间依赖
- 🐛 **路径问题** - 修复项目间引用路径

## [1.0.0] - 2025-05-30

### 新增
- 🎤 **语音交互** - 实时语音识别和合成
- 🌐 **通信协议** - WebSocket和MQTT双协议支持
- 🖥️ **用户界面** - WinUI 3桌面应用和控制台应用
- 🤖 **智能功能** - 自动对话模式和状态管理
- 🔊 **音频处理** - 基于Opus的高质量音频编解码
- ⚙️ **配置管理** - 灵活的配置系统
- 🔐 **安全通信** - WSS加密连接和验证机制
- 📱 **跨平台** - 支持Windows、Linux、macOS

### 技术架构
- 🏛️ **分层架构** - 清晰的服务层、通信层、核心层分离
- 🔌 **依赖注入** - 基于Microsoft.Extensions.DependencyInjection
- 📊 **日志系统** - 基于Microsoft.Extensions.Logging
- 🧪 **测试覆盖** - 完整的单元测试和集成测试
- 🔄 **MCP 协议基础** - 为 IoT 设备集成奠定基础架构

### 技术特性
- .NET 9.0支持
- 跨平台兼容性
- 音频编解码（Opus）
- 依赖注入架构
- 事件驱动设计
- 完整的日志记录

### 安全性
- WSS加密传输
- 安全的音频数据传输

[未发布]: https://github.com/maker-community/Verdure.Assistant/compare/v1.0.0...HEAD
[1.0.0]: https://github.com/maker-community/Verdure.Assistant/releases/tag/v1.0.0
