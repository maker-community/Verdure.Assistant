<?xml version="1.0" encoding="utf-8" ?>
<Window
    x:Class="XiaoZhi.WinUI.Views.MainWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    Title="å°æ™ºAIå®¢æˆ·ç«¯"
    mc:Ignorable="d">

    <Window.SystemBackdrop>
        <MicaBackdrop Kind="Base" />
    </Window.SystemBackdrop>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <!--  Navigation Header  -->
        <Border
            Grid.Row="0"
            Background="{ThemeResource ApplicationPageBackgroundThemeBrush}"
            BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
            BorderThickness="0,0,0,1">
            <NavigationView
                x:Name="MainNavigationView"
                IsBackButtonVisible="Collapsed"
                IsPaneToggleButtonVisible="False"
                IsSettingsVisible="False"
                PaneDisplayMode="Top"
                SelectionChanged="MainNavigationView_SelectionChanged">
                <NavigationView.MenuItems>
                    <NavigationViewItem
                        x:Name="MainPageNavItem"
                        Content="å¯¹è¯"
                        Icon="Message"
                        IsSelected="True"
                        Tag="MainPage" />
                    <NavigationViewItem
                        x:Name="SettingsNavItem"
                        Content="è®¾ç½®"
                        Icon="Setting"
                        Tag="SettingsPage" />
                </NavigationView.MenuItems>
            </NavigationView>
        </Border>

        <!--  Main Content  -->
        <Grid Grid.Row="1">
            <!--  Main Page  -->
            <Grid x:Name="MainPageContent" Visibility="Visible">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>

                <!--  Status Card  -->
                <Border
                    Grid.Row="0"
                    Margin="20,10,20,10"
                    Padding="16"
                    Background="{ThemeResource LayerFillColorDefaultBrush}"
                    CornerRadius="8">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <StackPanel
                            Grid.Column="0"
                            Orientation="Horizontal"
                            Spacing="12">
                            <FontIcon
                                x:Name="StatusIcon"
                                FontSize="20"
                                Foreground="{ThemeResource SystemAccentColor}"
                                Glyph="&#xE916;" />
                            <TextBlock
                                x:Name="StatusText"
                                VerticalAlignment="Center"
                                FontSize="14"
                                FontWeight="SemiBold"
                                Text="çŠ¶æ€: æœªè¿žæŽ¥" />
                        </StackPanel>

                        <StackPanel
                            Grid.Column="1"
                            Orientation="Horizontal"
                            Spacing="8">
                            <Border
                                x:Name="ConnectionIndicator"
                                Width="16"
                                Height="16"
                                Background="{ThemeResource SystemFillColorCriticalBrush}"
                                CornerRadius="8" />
                            <TextBlock
                                x:Name="ConnectionStatusText"
                                VerticalAlignment="Center"
                                FontSize="12"
                                Text="ç¦»çº¿" />
                        </StackPanel>
                    </Grid>
                </Border>

                <!--  Main Content Grid  -->
                <Grid Grid.Row="1" Margin="20,0,20,20">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="1*" MinWidth="350" />
                        <ColumnDefinition Width="15" />
                        <ColumnDefinition Width="1*" MinWidth="350" />
                    </Grid.ColumnDefinitions>

                    <!--  Left Panel: Emotion & Controls  -->
                    <Border
                        Grid.Column="0"
                        Padding="20"
                        Background="{ThemeResource LayerFillColorDefaultBrush}"
                        CornerRadius="12">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="*" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                            </Grid.RowDefinitions>

                            <!--  Emotion Display  -->
                            <Viewbox
                                Grid.Row="0"
                                MaxWidth="280"
                                MaxHeight="280"
                                Margin="10"
                                Stretch="Uniform">
                                <Border
                                    Width="280"
                                    Height="280"
                                    Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                                    CornerRadius="140">
                                    <Grid>
                                        <!--  Default Emotion  -->
                                        <TextBlock
                                            x:Name="DefaultEmotionText"
                                            HorizontalAlignment="Center"
                                            VerticalAlignment="Center"
                                            FontSize="100"
                                            Text="ðŸ˜Š" />

                                        <!--  Animated Emotion  -->
                                        <Image
                                            x:Name="EmotionImage"
                                            Stretch="Uniform"
                                            Visibility="Collapsed" />
                                    </Grid>
                                </Border>
                            </Viewbox>

                            <!--  TTS Text Display  -->
                            <Border
                                Grid.Row="1"
                                MinHeight="60"
                                Margin="0,15,0,0"
                                Padding="16"
                                Background="{ThemeResource CardBackgroundFillColorSecondaryBrush}"
                                CornerRadius="8">
                                <ScrollViewer MaxHeight="80" VerticalScrollBarVisibility="Auto">
                                    <TextBlock
                                        x:Name="TtsText"
                                        HorizontalAlignment="Center"
                                        VerticalAlignment="Center"
                                        FontSize="13"
                                        Text="å¾…å‘½"
                                        TextWrapping="Wrap" />
                                </ScrollViewer>
                            </Border>

                            <!--  Audio Controls Stack  -->
                            <Grid Grid.Row="2" Margin="0,15,0,0">
                                <!--  Volume Control  -->
                                <StackPanel x:Name="VolumeControlPanel" Spacing="8">
                                    <TextBlock
                                        FontSize="12"
                                        FontWeight="SemiBold"
                                        Opacity="0.8"
                                        Text="éŸ³é‡æŽ§åˆ¶" />
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto" />
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="Auto" />
                                        </Grid.ColumnDefinitions>

                                        <ToggleButton
                                            x:Name="MuteButton"
                                            Grid.Column="0"
                                            Width="32"
                                            Height="32"
                                            Margin="0,0,8,0"
                                            Click="MuteButton_Click">
                                            <FontIcon
                                                x:Name="MuteIcon"
                                                FontSize="14"
                                                Glyph="&#xE767;" />
                                        </ToggleButton>

                                        <Slider
                                            x:Name="VolumeSlider"
                                            Grid.Column="1"
                                            VerticalAlignment="Center"
                                            Maximum="100"
                                            Minimum="0"
                                            ValueChanged="VolumeSlider_ValueChanged"
                                            Value="80" />

                                        <TextBlock
                                            x:Name="VolumeText"
                                            Grid.Column="2"
                                            MinWidth="30"
                                            Margin="8,0,0,0"
                                            VerticalAlignment="Center"
                                            FontSize="11"
                                            Text="80%" />
                                    </Grid>
                                </StackPanel>

                                <!--  Microphone Visualizer (Hidden by default)  -->
                                <StackPanel
                                    x:Name="MicVisualizerPanel"
                                    Spacing="8"
                                    Visibility="Collapsed">
                                    <TextBlock
                                        FontSize="12"
                                        FontWeight="SemiBold"
                                        Opacity="0.8"
                                        Text="éº¦å…‹é£Žç›‘æµ‹" />
                                    <Border
                                        Height="50"
                                        Padding="10"
                                        Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                                        CornerRadius="8">
                                        <Canvas x:Name="MicVisualizerCanvas">
                                            <!--  Microphone level bars will be added here programmatically  -->
                                        </Canvas>
                                    </Border>
                                </StackPanel>
                            </Grid>

                            <!--  Control Buttons  -->
                            <Grid Grid.Row="3" Margin="0,20,0,0">
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                </Grid.RowDefinitions>

                                <!--  Manual Mode Button  -->
                                <Button
                                    x:Name="ManualButton"
                                    Grid.Row="0"
                                    Height="40"
                                    Margin="0,0,0,8"
                                    HorizontalAlignment="Stretch"
                                    PointerCaptureLost="ManualButton_PointerCaptureLost"
                                    PointerPressed="ManualButton_PointerPressed"
                                    PointerReleased="ManualButton_PointerReleased"
                                    Style="{ThemeResource AccentButtonStyle}">
                                    <StackPanel Orientation="Horizontal" Spacing="8">
                                        <FontIcon FontSize="16" Glyph="&#xE720;" />
                                        <TextBlock x:Name="ManualButtonText" Text="æŒ‰ä½åŽè¯´è¯" />
                                    </StackPanel>
                                </Button>

                                <!--  Auto Mode Button  -->
                                <Button
                                    x:Name="AutoButton"
                                    Grid.Row="0"
                                    Height="40"
                                    Margin="0,0,0,8"
                                    HorizontalAlignment="Stretch"
                                    Click="AutoButton_Click"
                                    Style="{ThemeResource AccentButtonStyle}"
                                    Visibility="Collapsed">
                                    <StackPanel Orientation="Horizontal" Spacing="8">
                                        <FontIcon FontSize="16" Glyph="&#xE768;" />
                                        <TextBlock x:Name="AutoButtonText" Text="å¼€å§‹å¯¹è¯" />
                                    </StackPanel>
                                </Button>

                                <!--  Abort Button  -->
                                <Button
                                    x:Name="AbortButton"
                                    Grid.Row="1"
                                    Height="36"
                                    Margin="0,0,0,8"
                                    HorizontalAlignment="Stretch"
                                    Click="AbortButton_Click">
                                    <StackPanel Orientation="Horizontal" Spacing="8">
                                        <FontIcon FontSize="14" Glyph="&#xE71A;" />
                                        <TextBlock Text="æ‰“æ–­å¯¹è¯" />
                                    </StackPanel>
                                </Button>

                                <!--  Mode Toggle Button  -->
                                <Button
                                    x:Name="ModeToggleButton"
                                    Grid.Row="2"
                                    Height="36"
                                    HorizontalAlignment="Stretch"
                                    Click="ModeToggleButton_Click"
                                    Style="{ThemeResource DefaultButtonStyle}">
                                    <StackPanel Orientation="Horizontal" Spacing="8">
                                        <FontIcon FontSize="14" Glyph="&#xE8AB;" />
                                        <TextBlock x:Name="ModeToggleText" Text="æ‰‹åŠ¨å¯¹è¯" />
                                    </StackPanel>
                                </Button>
                            </Grid>
                        </Grid>
                    </Border>

                    <!--  Right Panel: Input & Text  -->
                    <Border
                        Grid.Column="2"
                        Padding="20"
                        Background="{ThemeResource LayerFillColorDefaultBrush}"
                        CornerRadius="12">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="*" />
                            </Grid.RowDefinitions>

                            <!--  Connection Controls  -->
                            <!--<UniformGrid
                                Grid.Row="0"
                                Margin="0,0,0,15"
                                Columns="2">
                                <Button
                                    x:Name="ConnectButton"
                                    Height="36"
                                    Margin="0,0,5,0"
                                    Click="ConnectButton_Click"
                                    Style="{ThemeResource AccentButtonStyle}">
                                    <StackPanel Orientation="Horizontal" Spacing="8">
                                        <FontIcon
                                            x:Name="ConnectIcon"
                                            FontSize="16"
                                            Glyph="&#xE703;" />
                                        <TextBlock x:Name="ConnectText" Text="è¿žæŽ¥" />
                                    </StackPanel>
                                </Button>

                                <Button
                                    x:Name="DisconnectButton"
                                    Height="36"
                                    Margin="5,0,0,0"
                                    Click="DisconnectButton_Click"
                                    IsEnabled="False"
                                    Style="{ThemeResource SubtleButtonStyle}">
                                    <StackPanel Orientation="Horizontal" Spacing="8">
                                        <FontIcon FontSize="16" Glyph="&#xE711;" />
                                        <TextBlock Text="æ–­å¼€" />
                                    </StackPanel>
                                </Button>
                            </UniformGrid>-->

                            <!--  Text Input  -->
                            <Grid Grid.Row="1" Margin="0,0,0,15">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>

                                <TextBox
                                    x:Name="MessageTextBox"
                                    Grid.Column="0"
                                    Height="36"
                                    Margin="0,0,10,0"
                                    KeyDown="MessageTextBox_KeyDown"
                                    PlaceholderText="è¾“å…¥æ–‡å­—..." />

                                <Button
                                    x:Name="SendButton"
                                    Grid.Column="1"
                                    Height="36"
                                    MinWidth="60"
                                    Click="SendButton_Click"
                                    Style="{ThemeResource AccentButtonStyle}">
                                    <TextBlock Text="å‘é€" />
                                </Button>
                            </Grid>

                            <!--  Messages Display  -->
                            <Border
                                Grid.Row="2"
                                Padding="12"
                                Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                                CornerRadius="8">
                                <ScrollViewer
                                    x:Name="MessagesScrollViewer"
                                    VerticalScrollBarVisibility="Auto"
                                    ZoomMode="Disabled">
                                    <StackPanel x:Name="MessagesPanel" Spacing="8">
                                        <!--  Messages will be added here programmatically  -->
                                        <TextBlock
                                            Margin="0,20"
                                            HorizontalAlignment="Center"
                                            FontSize="13"
                                            Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                            Text="ç­‰å¾…å¯¹è¯å¼€å§‹..." />
                                    </StackPanel>
                                </ScrollViewer>
                            </Border>
                        </Grid>
                    </Border>
                </Grid>
            </Grid>

            <!--  Settings Page  -->
            <Grid x:Name="SettingsPageContent" Visibility="Collapsed">
                <ScrollViewer Padding="20" VerticalScrollBarVisibility="Auto">
                    <StackPanel MaxWidth="600" Spacing="20">

                        <!--  Page Title  -->
                        <TextBlock
                            Margin="0,0,0,10"
                            FontSize="24"
                            FontWeight="Bold"
                            Text="è®¾ç½®" />

                        <!--  Wake Word Settings  -->
                        <Expander Header="å”¤é†’è¯è®¾ç½®" IsExpanded="True">
                            <StackPanel Padding="0,12,0,0" Spacing="12">
                                <ToggleSwitch
                                    x:Name="WakeWordToggle"
                                    Header="å¯ç”¨å”¤é†’è¯å”¤é†’"
                                    IsOn="False"
                                    Toggled="WakeWordToggle_Toggled" />

                                <TextBox
                                    x:Name="WakeWordsTextBox"
                                    Header="å”¤é†’è¯ (å¤šä¸ªå”¤é†’è¯è¯·ç”¨è‹±æ–‡é€—å· ',' åˆ†éš”)"
                                    PlaceholderText="ä¾‹å¦‚: å°æ™º,å°æ™ºåŒå­¦"
                                    Text="" />
                            </StackPanel>
                        </Expander>

                        <!--  Device Settings  -->
                        <Expander Header="è®¾å¤‡è®¾ç½®" IsExpanded="True">
                            <StackPanel Padding="0,12,0,0" Spacing="12">
                                <TextBox
                                    x:Name="DeviceIdTextBox"
                                    Header="Device ID"
                                    PlaceholderText="è¾“å…¥è®¾å¤‡ID" />

                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="*" />
                                    </Grid.ColumnDefinitions>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                    </Grid.RowDefinitions>

                                    <TextBlock
                                        Grid.Row="0"
                                        Grid.ColumnSpan="2"
                                        Margin="0,0,0,8"
                                        Text="OTAåœ°å€:" />

                                    <ComboBox
                                        x:Name="OtaProtocolComboBox"
                                        Grid.Row="1"
                                        Grid.Column="0"
                                        MinWidth="100"
                                        Margin="0,0,8,0"
                                        SelectedIndex="0">
                                        <ComboBoxItem Content="https://" />
                                        <ComboBoxItem Content="http://" />
                                    </ComboBox>

                                    <TextBox
                                        x:Name="OtaAddressTextBox"
                                        Grid.Row="1"
                                        Grid.Column="1"
                                        PlaceholderText="è¾“å…¥OTAæœåŠ¡å™¨åœ°å€" />
                                </Grid>

                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="*" />
                                    </Grid.ColumnDefinitions>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                    </Grid.RowDefinitions>

                                    <TextBlock
                                        Grid.Row="0"
                                        Grid.ColumnSpan="2"
                                        Margin="0,12,0,8"
                                        Text="WebSocketåœ°å€:" />

                                    <ComboBox
                                        x:Name="WsProtocolComboBox"
                                        Grid.Row="1"
                                        Grid.Column="0"
                                        MinWidth="100"
                                        Margin="0,0,8,0"
                                        SelectedIndex="0">
                                        <ComboBoxItem Content="wss://" />
                                        <ComboBoxItem Content="ws://" />
                                    </ComboBox>

                                    <TextBox
                                        x:Name="WsAddressTextBox"
                                        Grid.Row="1"
                                        Grid.Column="1"
                                        PlaceholderText="è¾“å…¥WebSocketæœåŠ¡å™¨åœ°å€" />
                                </Grid>

                                <TextBox
                                    x:Name="WsTokenTextBox"
                                    Header="Access Token"
                                    PlaceholderText="è¾“å…¥è®¿é—®ä»¤ç‰Œ" />
                            </StackPanel>
                        </Expander>

                        <!--  Audio Settings  -->
                        <Expander Header="éŸ³é¢‘è®¾ç½®" IsExpanded="False">
                            <StackPanel Padding="0,12,0,0" Spacing="12">
                                <Slider
                                    x:Name="DefaultVolumeSlider"
                                    Header="é»˜è®¤éŸ³é‡"
                                    Maximum="100"
                                    Minimum="0"
                                    ValueChanged="DefaultVolumeSlider_ValueChanged"
                                    Value="80" />

                                <ToggleSwitch
                                    x:Name="AutoAdjustVolumeToggle"
                                    Header="è‡ªåŠ¨è°ƒèŠ‚éŸ³é‡"
                                    IsOn="True" />
                            </StackPanel>
                        </Expander>

                        <!--  Save Button  -->
                        <Button
                            x:Name="SaveSettingsButton"
                            Margin="0,20,0,0"
                            HorizontalAlignment="Left"
                            Click="SaveSettingsButton_Click"
                            Style="{ThemeResource AccentButtonStyle}">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <FontIcon FontSize="16" Glyph="&#xE74E;" />
                                <TextBlock Text="ä¿å­˜è®¾ç½®" />
                            </StackPanel>
                        </Button>
                    </StackPanel>
                </ScrollViewer>
            </Grid>
        </Grid>
    </Grid>
</Window>
